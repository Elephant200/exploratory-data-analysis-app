{% extends "base.html" %}
{% load static %}

{% block title %}Analysis | EDA Chatbot{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/pygments.css' %}"/>
<style>
    .main-layout {
        flex: 1;
        min-height: 0;
        display: flex;
        flex-direction: column;
        padding: 0.5rem;
    }
    .upload-box {
        flex-shrink: 0;
        padding: 0.5rem 1rem;
        border: 1px dashed #4a4a4a;
        border-radius: 0.375rem;
        cursor: pointer;
        text-align: center;
        color: #888;
        font-size: 0.875rem;
        transition: border-color 0.2s, background-color 0.2s;
        margin-bottom: 0.5rem;
    }
    .upload-box:hover {
        border-color: #6a6a6a;
        background-color: rgba(255,255,255,0.03);
    }
    .upload-box.uploaded {
        border-style: solid;
        border-color: #4a9eff;
        color: #4a9eff;
        cursor: default;
    }
    .upload-box.analyzing {
        border-color: #28a745;
        color: #28a745;
    }
    .upload-box.disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }
    #message-form {
        flex-shrink: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container main-layout">
    <div id="upload-box" class="upload-box" onclick="triggerUpload()">
        Upload File (CSV, TSV, JSON, Excel, TXT. Max 2MB)
    </div>
    <input type="file" id="file-input" accept=".csv,.tsv,.json,.xlsx,.xls,.txt" style="display:none" />
    
    <div class="chat-container p-3 border rounded" id="chat-container">
        <div class="message bot-message show">
            <p>{{ welcome_message }}</p>
        </div>
    </div>
    
    <form
        class="mt-2"
        hx-post="/api/chat/response/"
        hx-target="#chat-container"
        hx-swap="beforeend"
        hx-indicator="#typing-indicator"
        id="message-form"
    >
        {% csrf_token %}
        <div class="input-group">
            <input
                type="text"
                name="message"
                id="message-input"
                class="form-control"
                placeholder="Type your message..."
                autocomplete="off"
                required
            />
            <button class="btn btn-primary" type="submit">Send</button>
        </div>
    </form>
</div>

<template id="typing-indicator">
    <div class="typing-indicator">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
    </div>
</template>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/chat_messages.js"></script>
<script>
const uploadBox = document.getElementById('upload-box');
const fileInput = document.getElementById('file-input');
let uploadedFilename = null;

function triggerUpload() {
    if (!uploadBox.classList.contains('uploaded') && !uploadBox.classList.contains('disabled')) {
        fileInput.click();
    }
}

fileInput.addEventListener('change', async function() {
    if (!this.files || !this.files[0]) return;
    
    const file = this.files[0];
    uploadBox.textContent = 'Uploading...';
    uploadBox.classList.add('disabled');
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    try {
        const response = await fetch('/api/chat/upload/', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            uploadedFilename = data.filename;
            uploadBox.textContent = `Uploaded: ${data.filename}`;
            uploadBox.classList.remove('disabled');
            uploadBox.classList.add('uploaded');
        } else {
            uploadBox.textContent = `Error: ${data.error}`;
            uploadBox.classList.remove('disabled');
        }
    } catch (error) {
        uploadBox.textContent = 'Upload failed. Click to retry.';
        uploadBox.classList.remove('disabled');
    }
});

document.getElementById('message-form').addEventListener('submit', function() {
    if (uploadedFilename && uploadBox.classList.contains('uploaded') && !uploadBox.classList.contains('analyzing')) {
        uploadBox.textContent = `Analyzing: ${uploadedFilename}`;
        uploadBox.classList.add('analyzing');
    }
});
</script>
{% endblock %}
