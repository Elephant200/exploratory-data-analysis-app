{% extends "base.html" %}
{% load static %}

{% block title %}Analysis | EDA Chatbot{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/pygments.css' %}"/>
<style>
    .main-layout {
        height: calc(100vh - 8rem);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    .chat-container {
        flex: 1;
        overflow-y: auto;
        min-height: 0;
    }
    #upload-area {
        flex-shrink: 0;
    }
    #message-form {
        flex-shrink: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container main-layout">
    <div id="upload-area">
        <form
            class="mb-2"
            hx-post="/api/chat/upload/"
            hx-target="#chat-container"
            hx-swap="beforeend"
            enctype="multipart/form-data"
            id="upload-form"
        >
            {% csrf_token %}
            <div class="input-group input-group-sm">
                <input
                    type="file"
                    name="file"
                    id="file-input"
                    class="form-control"
                    accept=".csv,.tsv,.json,.xlsx,.xls,.txt"
                    required
                />
                <button class="btn btn-secondary" type="submit" id="upload-btn">
                    Upload Dataset
                </button>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-1">
                <small class="text-muted">Formats: CSV, TSV, JSON, Excel, TXT. Max 2MB.</small>
                <small id="upload-status" class="text-muted"></small>
            </div>
        </form>
    </div>
    <div class="chat-container p-3 border rounded" id="chat-container">
        <div class="message bot-message show">
            <p>{{ welcome_message }}</p>
        </div>
    </div>
    <form
        class="mt-2"
        hx-post="/api/chat/response/"
        hx-target="#chat-container"
        hx-swap="beforeend"
        hx-indicator="#typing-indicator"
        id="message-form"
    >
        {% csrf_token %}
        <div class="input-group">
            <input
                type="text"
                name="message"
                id="message-input"
                class="form-control"
                placeholder="Type your message..."
                autocomplete="off"
                required
            />
            <button class="btn btn-primary" type="submit">Send</button>
        </div>
    </form>
</div>

<template id="typing-indicator">
    <div class="typing-indicator">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
    </div>
</template>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/chat_messages.js"></script>
<script>
document.body.addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.elt.id === 'upload-form' && event.detail.successful) {
        const fileInput = document.getElementById('file-input');
        const uploadBtn = document.getElementById('upload-btn');
        const status = document.getElementById('upload-status');
        
        if (fileInput && uploadBtn && status) {
            const fileName = fileInput.files[0] ? fileInput.files[0].name : 'File';
            fileInput.disabled = true;
            uploadBtn.disabled = true;
            uploadBtn.classList.add('disabled');
            status.textContent = `Analyzing: ${fileName}. Reload to change file.`;
        }
    }
});
</script>
{% endblock %}
