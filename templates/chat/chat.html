{% extends "base.html" %}
{% load static %}

{% block title %}Analysis | EDA Chatbot{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/pygments.css' %}"/>
<style>
    body {
        height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    .main-layout {
        flex: 1;
        min-height: 0;
        display: flex;
        flex-direction: column;
        padding: 0.5rem 0.5rem 0 0.5rem;
    }
    .upload-box {
        flex-shrink: 0;
        padding: 0.5rem 1rem;
        border: 1px dashed #4a4a4a;
        border-radius: 0.375rem;
        cursor: pointer;
        text-align: center;
        color: #888;
        font-size: 0.875rem;
        transition: border-color 0.2s, background-color 0.2s;
        margin-bottom: 0.5rem;
    }
    .upload-box:hover {
        border-color: #6a6a6a;
        background-color: rgba(255,255,255,0.03);
    }
    .upload-box.uploaded {
        border-style: solid;
        border-color: #4a9eff;
        color: #4a9eff;
        cursor: default;
    }
    .upload-box.analyzing {
        border-color: #28a745;
        color: #28a745;
    }
    .upload-box.disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }
    #message-form {
        flex-shrink: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container main-layout">
    <div id="upload-box" class="upload-box" onclick="triggerUpload()">
        Upload File (CSV, TSV, JSON, Excel, TXT. Max 2MB)
    </div>
    <input type="file" id="file-input" accept=".csv,.tsv,.json,.xlsx,.xls,.txt" style="display:none" />
    
    <div class="chat-container p-3 border rounded" id="chat-container">
        <div class="message bot-message show">
            <p>{{ welcome_message }}</p>
        </div>
    </div>
    
    <form
        class="mt-2 mb-1"
        id="message-form"
        onsubmit="handleStreamSubmit(event)"
    >
        {% csrf_token %}
        <div class="input-group">
            <input
                type="text"
                name="message"
                id="message-input"
                class="form-control"
                placeholder="Type your message..."
                autocomplete="off"
                required
            />
            <button class="btn btn-primary" type="submit" id="send-button">Send</button>
        </div>
    </form>
</div>

<template id="typing-indicator">
    <div class="typing-indicator">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
    </div>
</template>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/chat_messages.js"></script>
<script>
const uploadBox = document.getElementById('upload-box');
const fileInput = document.getElementById('file-input');
let uploadedFilename = null;
const demoFileUrl = "{% static 'demo/CONED Natural Gas Data.csv' %}";
let demoAutoSend = false;
let demoMessageSent = false;

function triggerUpload() {
    if (!uploadBox.classList.contains('uploaded') && !uploadBox.classList.contains('disabled')) {
        fileInput.click();
    }
}

async function uploadFile(file) {
    uploadBox.textContent = 'Uploading...';
    uploadBox.classList.add('disabled');
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    try {
        const response = await fetch('/api/chat/upload/', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            uploadedFilename = data.filename;
            uploadBox.textContent = `Uploaded: ${data.filename}`;
            uploadBox.classList.remove('disabled');
            uploadBox.classList.add('uploaded');
            
            // Fill message input if empty
            const messageInput = document.getElementById('message-input');
            if (!messageInput.value.trim()) {
                messageInput.value = 'Please analyze this file and provide a summary of the data.';
                messageInput.focus();
            }
            if (demoAutoSend && !demoMessageSent && messageInput.value.trim()) {
                demoMessageSent = true;
                const messageForm = document.getElementById('message-form');
                if (messageForm) {
                    messageForm.requestSubmit();
                }
            }
        } else {
            uploadBox.textContent = `Error: ${data.error}`;
            uploadBox.classList.remove('disabled');
        }
    } catch (error) {
        uploadBox.textContent = 'Upload failed. Click to retry.';
        uploadBox.classList.remove('disabled');
    }
}

fileInput.addEventListener('change', async function() {
    if (!this.files || !this.files[0]) return;
    await uploadFile(this.files[0]);
});

async function startDemoUpload() {
    if (uploadedFilename || uploadBox.classList.contains('uploaded')) return;
    
    uploadBox.textContent = 'Loading demo file...';
    uploadBox.classList.add('disabled');
    
    try {
        const response = await fetch(demoFileUrl);
        if (!response.ok) {
            throw new Error('Failed to fetch demo file');
        }
        const blob = await response.blob();
        const demoFile = new File([blob], 'CONED Natural Gas Data.csv', {
            type: blob.type || 'text/csv'
        });
        await uploadFile(demoFile);
    } catch (error) {
        uploadBox.textContent = 'Demo load failed. Click to upload a file.';
        uploadBox.classList.remove('disabled');
    }
}

const demoParam = new URLSearchParams(window.location.search).get('demo');
if (demoParam === 'coned') {
    const cleanUrl = new URL(window.location.href);
    cleanUrl.searchParams.delete('demo');
    history.replaceState({}, '', cleanUrl.pathname + cleanUrl.search + cleanUrl.hash);
    demoAutoSend = true;
    startDemoUpload();
}

// Update upload box status when sending a message with a file
const originalHandleStreamSubmit = handleStreamSubmit;
handleStreamSubmit = async function(event) {
    if (uploadedFilename && uploadBox.classList.contains('uploaded') && !uploadBox.classList.contains('analyzing')) {
        uploadBox.textContent = `Analyzing: ${uploadedFilename}`;
        uploadBox.classList.add('analyzing');
    }
    return originalHandleStreamSubmit(event);
};
</script>
{% endblock %}
