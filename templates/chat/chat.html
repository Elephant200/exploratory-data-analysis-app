{% extends "base.html" %}
{% load static %}

{% block title %}Analysis | EDA Chatbot{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/pygments.css' %}"/>
{% endblock %}

{% block content %}
<div class="container">
    <div id="upload-area">
        <form
            class="mb-3"
            hx-post="/api/chat/upload/"
            hx-target="#chat-container"
            hx-swap="beforeend"
            enctype="multipart/form-data"
            id="upload-form"
        >
            {% csrf_token %}
            <div class="input-group">
                <input
                    type="file"
                    name="file"
                    class="form-control"
                    accept=".csv,.tsv,.json,.xlsx,.xls,.txt"
                    required
                />
                <button class="btn btn-secondary" type="submit" id="upload-btn">
                    Upload Dataset
                </button>
            </div>
            <small class="text-muted">Supported formats: CSV, TSV, JSON, Excel (.xlsx, .xls), and plain text files. Max 2 MB.</small>
        </form>
    </div>
    <div class="chat-container p-3 border rounded" id="chat-container">
        <div class="message bot-message show">
            <p>{{ welcome_message }}</p>
        </div>
    </div>
    <form
        class="mt-3"
        hx-post="/api/chat/response/"
        hx-target="#chat-container"
        hx-swap="beforeend"
        hx-indicator="#typing-indicator"
        id="message-form"
    >
        {% csrf_token %}
        <div class="input-group">
            <input
                type="text"
                name="message"
                id="message-input"
                class="form-control"
                placeholder="Type your message..."
                autocomplete="off"
                required
            />
            <button class="btn btn-primary" type="submit">Send</button>
        </div>
    </form>
</div>

<template id="typing-indicator">
    <div class="typing-indicator">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
    </div>
</template>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/chat_messages.js"></script>
<script>
document.body.addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.elt.id === 'upload-form' && event.detail.successful) {
        document.getElementById('upload-area').innerHTML = 
            '<div class="alert alert-info mb-3"><small>File uploaded successfully. Reload the page to analyze a different file.</small></div>';
    }
});
</script>
{% endblock %}
